---
# SonarQube Docker Compose 배포 (참고: Continous-integration/SonarQube/)

- name: Ensure Docker and Docker Compose are available
  ansible.builtin.dnf:
    name:
      - docker
      - docker-compose-plugin
    state: present
  when: ansible_os_family == "RedHat"
  ignore_errors: true

- name: Ensure Docker is started and enabled
  ansible.builtin.systemd:
    name: docker
    state: started
    enabled: true

- name: Ensure SonarQube deploy directory exists
  ansible.builtin.file:
    path: "{{ sonarqube_deploy_dir }}"
    state: directory
    mode: "0755"

- name: Deploy docker-compose.yml for SonarQube
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: "{{ sonarqube_deploy_dir }}/docker-compose.yml"
    mode: "0644"

- name: Start SonarQube stack with Docker Compose
  ansible.builtin.shell: |
    cd {{ sonarqube_deploy_dir }}
    docker compose up -d
  register: sonar_compose_run
  changed_when: true

- name: Display SonarQube completion message
  ansible.builtin.debug:
    msg: |
      SonarQube 배포가 완료되었습니다.
      URL: http://{{ ansible_host | default(inventory_hostname) }}:{{ sonarqube_port }}
  run_once: true
